# CI config

# shared key for the python jobs to not have redundant config parameters
# PROJECT, TESTSDIR, SRCDIR are used in the tox.ini
# cp -no-clobber copies files but doesn't overwrite existing ones (e.g. sonar property settings)
.python_defaults: &py_anchor  # using anchor magic
    image: registry.gitlab.semanticlab.net/docker/py3base:latest
    before_script:
        - git submodule sync --recursive
        - git submodule update --init --recursive --remote
        - cp --no-clobber wl_python_utils/python3/* .
        - sed -i s/-dev//g setup.py
        - export PROJECT=$(/usr/bin/python3 -W ignore ./setup.py --name | awk 'NR==1{print $1}')
        - export VERSION=$(/usr/bin/python3 -W ignore ./setup.py --version | awk 'NR==1{print $1}')
        - export TESTSDIR=src/python/weblyzard_api/tests/model/
        - export SRCDIR=src/python/weblyzard_api/
    only:
        - migration
    tags:
        - docker

stages:
    - test-python
    - test-java
    - build-package

pytest:
    <<: *py_anchor  # we reference the anchor here
    stage: test-python
    script:
        - tox -e pytest
        - sonar-scanner -D sonar.host.url=$sonarhost -D sonar.login=$sonarlogin

pylint:
    <<: *py_anchor
    stage: test-python
    script:
        - tox -e pylint
    when: manual

vulture:
    <<: *py_anchor
    stage: test-python
    script:
        - tox -e vulture
    when: manual

sonarqube:
    stage: test-java
    script:
        - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install -DskipITs -Dgpg.skip=true -Dmaven.test.failure.ignore=false sonar:sonar -Dsonar.login=$sonarlogin -Dsonar.host.url=$sonarhost
        - cd java-examples/keyword-extraction; mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install -DskipITs -Dgpg.skip=true -Dmaven.test.failure.ignore=false sonar:sonar -Dsonar.login=$sonarlogin -Dsonar.host.url=$sonarhost
    only:
        - migration
    tags:
        - java10

# the sed and exports needed are in the actual build-package.sh
build:
    stage: build-package
    before_script:
        - git submodule sync --recursive
        - git submodule update --init --recursive --remote
        - cp --no-clobber wl_python_utils/python3/* .
        - sed -i s/-dev//g setup.py
    script:
        - chmod +x build-package.sh
        - ./build-package.sh
    only:
        - migration
    when: manual
    tags:
        - shell-runner
